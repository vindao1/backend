<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2a2d2e;
            --primary-color: #3484F0;
            --primary-hover: #22559b;
            --text-color: #e0e0e0;
            --text-muted: #888;
            --border-color: #343638;
            --success-color: #1D6F42;
            --danger-color: #d32f2f;
            --danger-hover: #b71c1c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            flex-grow: 1;
        }

        header h1 {
            text-align: center;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card h2 {
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        button, .button-like {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s;
            text-align: center;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        #action-button {
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: auto;
        }

        #action-button.stop-mode {
            background-color: var(--danger-color);
        }
        #action-button.stop-mode:hover {
            background-color: var(--danger-hover);
        }

        #export-button {
            background-color: var(--success-color);
            color: white;
        }

        textarea {
            width: 100%;
            height: 120px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            padding: 10px;
            font-family: 'Inter', sans-serif;
            resize: vertical;
        }

        .file-info {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: -5px;
        }

        .status-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 250px;
        }

        #qr-code-image {
            width: 250px;
            height: 250px;
            background-color: #fff;
            border-radius: 8px;
        }
        
        .login-success {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--success-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .stat-item p {
            font-size: 2rem;
            font-weight: 700;
        }
        
        #log-container {
            height: 250px;
            overflow-y: scroll;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            background-color: var(--bg-color);
            flex-grow: 1;
        }
        
        #log-container div {
            padding: 2px 0;
        }

        footer {
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>WhatsApp Panel</h1>
        </header>

        <main class="main-grid">
            <section class="card">
                <div class="card-content">
                    <h2>1. Unggah Kontak (.xlsx atau .txt)</h2>
                    <input type="file" id="contact-file-input" accept=".xlsx, .txt" style="display: none;">
                    <button onclick="document.getElementById('contact-file-input').click();">Pilih File Kontak...</button>
                    <span id="contact-file-info" class="file-info">Belum ada file dipilih</span>
                </div>
                <div class="card-content">
                    <h2>2. Tulis Pesan (gunakan {nama})</h2>
                    <textarea id="message-box" placeholder="Halo {nama}, ini adalah pesan otomatis."></textarea>
                </div>
                <div class="card-content">
                    <h2>3. Lampirkan Gambar (Opsional)</h2>
                    <input type="file" id="image-file-input" accept="image/png, image/jpeg" multiple style="display: none;">
                    <button onclick="document.getElementById('image-file-input').click();">Pilih Gambar...</button>
                    <span id="image-file-info" class="file-info">Tidak ada gambar dipilih</span>
                </div>
                <button id="action-button">Mulai Kirim Sekarang</button>
            </section>

            <section class="card" style="gap: 20px;">
                <div class="card-content">
                    <h2>Status Koneksi</h2>
                    <div id="status-container" class="status-container">
                        <p id="status-text">Menghubungkan ke server...</p>
                        <img id="qr-code-image" src="" alt="QR Code" style="display: none;">
                    </div>
                </div>
                 <div class="card-content">
                    <h2>Log Aktivitas</h2>
                    <button id="export-button" disabled>Ekspor Log ke Excel</button>
                    <div id="log-container"></div>
                </div>
            </section>
        </main>
    </div>

    <footer>
        <span id="user-info-label">Pengguna: -</span>
    </footer>

    <script>
        // --- Referensi Elemen DOM ---
        const logContainer = document.getElementById('log-container');
        const actionButton = document.getElementById('action-button');
        const exportButton = document.getElementById('export-button');
        const contactFileInput = document.getElementById('contact-file-input');
        const contactFileInfo = document.getElementById('contact-file-info');
        const imageFileInput = document.getElementById('image-file-input');
        const imageFileInfo = document.getElementById('image-file-info');
        const messageBox = document.getElementById('message-box');
        const statusContainer = document.getElementById('status-container');
        const statusText = document.getElementById('status-text');
        const qrCodeImage = document.getElementById('qr-code-image');

        // --- State Aplikasi ---
        let mySessionId = null;
        let isSending = false;
        let contactFile = null;
        let imageFiles = [];

        // --- Koneksi WebSocket ---
        const socket = new WebSocket('ws://' + window.location.host); // Otomatis menggunakan host yang sama

        socket.onopen = () => {
            updateLog('Koneksi ke server berhasil.');
        };

        socket.onclose = () => {
            updateLog('Koneksi terputus. Coba refresh halaman.');
            actionButton.disabled = true;
            actionButton.innerText = 'Koneksi Terputus';
        };

        socket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            
            switch(message.type) {
                case 'session_created':
                    mySessionId = message.sessionId;
                    console.log('Sesi ID diterima:', mySessionId);
                    break;
                case 'log':
                    updateLog(message.data);
                    break;
                case 'status':
                    updateStatus(message.data);
                    break;
                case 'qr':
                    displayQrCode(message.data);
                    break;
                case 'excel_ready':
                    updateLog(`Laporan Excel siap. <a href="${message.data.url}" target="_blank" download>Unduh di sini</a>`);
                    exportButton.disabled = false;
                    exportButton.innerText = 'Ekspor Log ke Excel';
                    break;
                case 'finish':
                    setSendingState(false);
                    break;
            }
        };

        // --- Fungsi Logika ---

        const updateLog = (htmlMessage) => {
            logContainer.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${htmlMessage}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
            exportButton.disabled = false; // Aktifkan tombol ekspor setelah ada log
        };

        const updateStatus = (status) => {
            qrCodeImage.style.display = 'none';
            statusText.style.display = 'block';

            switch(status) {
                case 'initializing':
                    statusText.innerHTML = 'Memulai sesi browser di server...';
                    actionButton.disabled = true;
                    break;
                case 'scan_required':
                    statusText.innerHTML = 'Silakan pindai QR Code di bawah ini.';
                    actionButton.disabled = true;
                    break;
                case 'loggedin':
                    statusText.innerHTML = '<span class="login-success">âœ… Berhasil Login!</span>';
                    actionButton.disabled = false;
                    break;
                case 'error':
                    statusText.innerHTML = '<span style="color: var(--danger-color);">Terjadi error di server. Cek log.</span>';
                    actionButton.disabled = true;
                    break;
            }
        };

        const displayQrCode = (base64Image) => {
            statusText.style.display = 'block';
            qrCodeImage.style.display = 'block';
            qrCodeImage.src = base64Image;
        };

        const setSendingState = (sending) => {
            isSending = sending;
            contactFileInput.disabled = sending;
            imageFileInput.disabled = sending;
            messageBox.disabled = sending;
            
            if (sending) {
                actionButton.innerText = 'Hentikan Pengiriman';
                actionButton.classList.add('stop-mode');
            } else {
                actionButton.innerText = 'Mulai Kirim Sekarang';
                actionButton.classList.remove('stop-mode');
            }
        };
        
        // --- Event Listeners ---
        
        contactFileInput.onchange = (e) => {
            contactFile = e.target.files[0];
            if (contactFile) {
                contactFileInfo.innerText = contactFile.name;
            } else {
                contactFileInfo.innerText = 'Belum ada file dipilih';
            }
        };

        imageFileInput.onchange = (e) => {
            imageFiles = Array.from(e.target.files);
            if (imageFiles.length > 0) {
                imageFileInfo.innerText = imageFiles.map(f => f.name).join(', ');
            } else {
                imageFileInfo.innerText = 'Tidak ada gambar dipilih';
            }
        };

        actionButton.onclick = () => {
            if (isSending) {
                // Hentikan pengiriman
                socket.send(JSON.stringify({ sessionId: mySessionId, type: 'stop_sending' }));
            } else {
                // Mulai pengiriman
                startSending();
            }
        };

        exportButton.onclick = () => {
            if (!mySessionId) return alert('Sesi belum siap.');
            exportButton.disabled = true;
            exportButton.innerText = 'Membuat Laporan...';
            socket.send(JSON.stringify({ sessionId: mySessionId, type: 'export_excel' }));
        };

        const startSending = async () => {
            if (!mySessionId) return alert('Sesi belum siap.');
            if (!contactFile) return alert('Silakan pilih file kontak terlebih dahulu.');
            if (!messageBox.value.trim()) return alert('Pesan tidak boleh kosong.');

            setSendingState(true);

            try {
                // Baca file kontak
                const contactsContent = await readFileAsText(contactFile);
                
                // Baca file gambar (jika ada) dan konversi ke base64
                const imageBase64Data = await Promise.all(
                    imageFiles.map(file => readFileAsBase64(file))
                );

                const payload = {
                    sessionId: mySessionId,
                    type: 'send_messages',
                    data: {
                        contacts: parseContacts(contactsContent, contactFile.name.endsWith('.xlsx')),
                        message: messageBox.value,
                        imageBase64Data: imageBase64Data // Array berisi string base64
                    }
                };
                
                socket.send(JSON.stringify(payload));

            } catch (error) {
                alert('Gagal membaca file: ' + error.message);
                setSendingState(false);
            }
        };
        
        // --- Fungsi Utility untuk Baca File ---

        const readFileAsText = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsText(file);
            });
        };

        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    // event.target.result adalah data URL: "data:image/png;base64,iVBORw0KGgo..."
                    // Kita hanya butuh bagian setelah koma
                    const base64String = event.target.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const parseContacts = (content, isExcel) => {
            // NOTE: Parsing Excel (XLSX) di sisi client sangat rumit.
            // Untuk sekarang, kita anggap semua file adalah TXT.
            // Untuk XLSX, idealnya dikirim ke server untuk diparsing.
            if (isExcel) {
                updateLog("Peringatan: Parsing file .xlsx di browser tidak didukung dalam contoh ini. Mohon gunakan format .txt (satu nomor per baris).");
                // Anda bisa menambahkan library seperti 'xlsx' di sini jika diperlukan
            }

            // Parsing sederhana untuk file .txt (nomor<spasi/koma>nama)
            return content.split('\n').map(line => {
                line = line.trim();
                if (!line) return null;
                
                let nomor, nama;
                const parts = line.split(/[, \t]+/); // Pisahkan dengan koma, spasi, atau tab
                nomor = parts[0] || '';
                nama = parts.slice(1).join(' ') || '';
                
                return { nomor, nama };
            }).filter(Boolean); // Hapus baris kosong
        };

    </script>
</body>
</html>